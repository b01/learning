# Initialize the Control Plane

If you'd like to set up a Dualstack cluster then you'll need:
1. Kubernetes 1.20 or later
2. Nodes with routable IPv4 and IPv6 addresses.
3. A network plugin that supports dual-stack.
4. Configure IPv4/IPv6 dual-stack
   1. kube-apiserver: `--service-cluster-ip-range=<IPv4 CIDR>,<IPv6 CIDR>`
   2. kube-controller-manager:
      ```
      --cluster-cidr=<IPv4 CIDR>,<IPv6 CIDR>
      --service-cluster-ip-range=<IPv4 CIDR>,<IPv6 CIDR>
      --node-cidr-mask-size-ipv4|--node-cidr-mask-size-ipv6
      ```
   3. kube-proxy (or replacement): `--cluster-cidr=<IPv4 CIDR>,<IPv6 CIDR>`
   4. kubelet: `--node-ip=<IPv4 IP>,<IPv6 IP>`

For more details review [Configure IPv4/IPv6 dual-stack].

Time to start the kubelet service on the control-plane which, in turn, will
start the control-plane components using their manifest located in
`/etc/kubernetes/manifest`.

NOTE: This guide avoids some of the [TLS bootstrapping] process because it is a
cumbersome flow to perform manually.
However, the best part of the TLS bootstrapping process this guide will walk
you through. That's the part where the `kubelet` and the
`kube-controller-manager` are configured so that nodes can auto-renew their
TLS certificates.

1. Make a configuration for the `kubelet`:
   1. Copy the `samples/config.yaml` over to the `control-plane-01`.
   2. Move the `config.yaml` to `/var/lib/kubelet` directory:
      ```shell
      sudo mkdir -p /var/lib/kubelet
      sudo cp config.yaml /var/lib/kubelet
      ```
2. Make a `systemd` unit for the `kubelet.service` which tells the `kubelet`
   service where to find its configuration file and the kubeconfig for
   authenticating with the `kube-apiserver`.
   ```shell
   read IP4 IP6 <<< "$(hostname -I)"
   export IPV4=${IP4}
   export IPV6=${IP6}
   sudo mkdir -p /etc/systemd/system/kubelet.service.d
   cat <<'TXT' | tee kubelet.service.tmpl
   [Service]
   ExecStart=
   ExecStart=/usr/bin/kubelet --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --node-ip='${IPV4},${IPV6}'
   TXT
   envsubst < kubelet.service.tmpl | sudo tee /etc/systemd/system/kubelet.service.d/kubelet.conf
   ```
3. Copy the `kubelet` key and certificate, and kubeconfig into place.
   ```shell
   sudo mkdir -p /var/lib/kubelet/pki
   sudo cp ~/certs/control-plane-01.key /var/lib/kubelet/pki/kubelet.key
   sudo cp ~/certs/control-plane-01.crt /var/lib/kubelet/pki/kubelet.crt
   sudo cp ~/certs/control-plane-01.conf /etc/kubernetes/kubelet.conf
   ```
4. Start the cluster components.
   ```shell
   sudo systemctl daemon-reload
   sudo systemctl start kubelet.service
   ```
5. Then check the status of the `kubelet` to make sure it booted successfully.
   ```shell
   sudo systemctl status kubelet.service
   ```
6. Mark the node as a control-plane by adding the following Label and Taint.
   The Taint will prevent Pods from being scheduled on the control-plane unless
   configured to do so; while the label distinguishes it from worker nodes.
   ```shell
   sudo kubectl label nodes control-plane-01 node-restriction.kubernetes.io/control-plane=true \
     --kubeconfig=/etc/kubernetes/super-admin.conf
   sudo kubectl taint nodes control-plane-01 control-plane:NoSchedule \
     --kubeconfig=/etc/kubernetes/super-admin.conf
   ```
   NOTE: We have not set a default kubeconfig for accessing the cluster at this
   point, which is why we have to specify one. Very useful when you need to try
   out a different config for any reason.

NOTE: If your having issues you can review the `kubelet` logs with
`sudo journalctl -u kubelet.service`.

Next: [Configure Networking]

---

[TLS bootstrapping]: https://kubernetes.io/docs/reference/access-authn-authz/kubelet-tls-bootstrapping
[Configure Networking]: /kubernetes/4.5-configure-networking.md
[Configure IPv4/IPv6 dual-stack]: https://kubernetes.io/docs/concepts/services-networking/dual-stack/#configure-ipv4-ipv6-dual-stack
