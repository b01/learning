# OIDC Google

Your application can use Google's OAuth 2.0 authentication system for user
login. Full instructions can be found at [OpenID Connect].

## Notes

1. You must go to [Google Cloud Console] and select or make a new a project. 
2. To obtain OAuth 2.0 credentials, go to APIs and Services > [Credentials]
   and create a pair for your app. You need OAuth 2.0 credentials (client ID
   and client secret), to authenticate users and gain access to Google's APIs.
   1. Set the client name to what you like. 
   2. Set a redirect URI. This determines where Google sends users after they
      authenticate. This is usually where you want them to land after they log
      in.

Now that you have this, it is time to code. Implement the Google Auth as a means
for user log in.

###  Authenticating Clients Using Server Flow

Authenticating the user involves obtaining an ID token and validating it. Here
how.

Time to code:

1. Set up your application to store session state. That is beyond the scope of
   this TLDR.
2. Make a unique session token in code, for example in Go:
   ```go
   func NewState() string {
    	return uuid.New().String()
   }
   ```
   and store it as the field "state" in your server's session. This will be
   used for anti-forgery attacks. Match this with the authentication response
   returned by the Google OAuth Login service to verify that the user is making
   the request and not a malicious attacker.
   One good choice for a state token is a string of 30 or so characters
   constructed using a high-quality random-number generator. Another is a hash
   generated by signing some of your session state variables with a key that is
   kept secret on your back-end.
3. Send an authentication request to Google, specify the following parameters:
   ```http request
   ### Google Authentication Request 
   GET https://accounts.google.com/o/oauth2/v2/auth
       ?response_type=code
       &client_id=424911365001.apps.googleusercontent.com
       &scope=openid%20email
       &redirect_uri=https%3A//oauth2.example.com/code
       &state=security_token%3D138r5719ru3e1%26url%3Dhttps%3A%2F%2Foauth2-login-demo.example.com%2FmyHome
       &login_hint=jsmith@example.com
       &nonce=0394852-3190485-2490358
       &access_type=offline
   
   ###
   ```
   NOTE: You need to have your app redirect the client to this page, upon 
         success, Google will redirect a GET request to the Redirect URI you
         entered for the callback field when you set up the OAuth2.0
         credentials.
4. Confirm anti-forgery state token on your callback page. Merely validate that
   it matches what you sent:
    ```go
    queryParams := r.URL.Query()
	code := queryParams.Get("code")
	scope := queryParams.Get("scope")
	state := queryParams.Get("state")
	sessionSate := server.sm.Get("state")

	if len(state) < 30 || len(sessionSate) < 30 {
		// Log error and redirect to login page.
		Log.Errf(stderr.InvalidState)
		w.Header().Set("Location", "/")
		w.WriteHeader(http.StatusSeeOther)
	}

	if string(sessionSate) != state {
		Log.Errf(stderr.StateMismatch)
		// Log error and redirect to login page.
		w.Header().Set("Location", "/")
		w.WriteHeader(http.StatusSeeOther)
    }
    // proceed
    ```
5. Exchange code for access token and ID token

---

[OpenID Connect]: https://developers.google.com/identity/openid-connect/openid-connect
[Google Cloud Console]: https://console.cloud.google.com/home/dashboard
[Credentials]: https://console.cloud.google.com/apis/credentials
[Discovery document]: https://accounts.google.com/.well-known/openid-configuration
