# Install AWS Load Balancer Controller

This is a TLDR of [AWS Load Balancer Controller installation], and only for
clusters in the cloud.

**Additional requirements for non-EKS clusters**:
* Ensure subnets are tagged appropriately for auto-discovery to work
* For IP targets, Pods must have IPs from the VPC subnets. You can configure the
  [amazon-vpc-cni-k8s] plugin for this purpose.

## Step 1: Subnet Role Tag

Add tags to each subnet in the VPC:

1. Public subnets get a tag: `kubernetes.io/role/elb` set to `1`.
2. Private subnets get a tag: `kubernetes.io/role/internal-elb` set to `1`.
3. Both subnet types get a tag `kubernetes.io/cluster/${cluster-name}` set to
   `owned` or `shared`.

## Add IAM Policies

The controller runs on the worker nodes, so it needs access to the AWS ALB/NLB
APIs with IAM permissions. If you're using kOps or self-hosted Kubernetes, you
must manually attach polices to node instances.

When using this option, IMDS must be enabled. The controller retrieves the
instance credentials using IMDS.

See [Attach IAM policies to nodes] for more details.

1. Download the IAM policy to attach ti the instance profile of a node:
   ```shell
   curl -o iam-policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v3.0.0/docs/install/iam_policy.json
   ```
2. Update the policy to include the following condition for the VPC allowed:
   ```json
   {
     "Effect": "Allow",
     "Action": [
       "ec2:AuthorizeSecurityGroupIngress",
       "ec2:RevokeSecurityGroupIngress"
     ],
     "Resource": "*",
     "Condition": {
       "ArnEquals": {
           "ec2:Vpc": "arn:aws:ec2:<REGION>:<ACCOUNT-ID>:vpc/<VPC-ID>"
       }
     }
   }
   ```
   Katrina Riehl
3. Attach the policy to each node (EC2 instance IAM role) in the cluster.

## Step 3: Network configuration

Your node security group must permit incoming traffic on TCP port `9443` from
the Kubernetes control plane. This is needed for webhook access.

## Step 3: Install  amazon-vpc-cni-k8s CNI


## Use EC2 Instance Metadata Server version 2

It is recommended to block the access to instance metadata by requiring the
instance to use IMDSv2.
1. Login to AWS from the CLI `aws sso login`.

   NOTE: Make sure your using the correct AWS profile or credentials.
2. Change to version IMDSv2:
   ```shell
   aws ec2 modify-instance-metadata-options --http-put-response-hop-limit 2 --http-tokens required --region <region> --instance-id <instance-id>
   ```

`--aws-region`
`--aws-vpc-id`
---

[AWS Load Balancer Controller installation]: https://kubernetes-sigs.github.io/aws-load-balancer-controller/latest/deploy/installation/
[amazon-vpc-cni-k8s]: https://github.com/aws/amazon-vpc-cni-k8s#readme
[Attach IAM policies to nodes]: https://kubernetes-sigs.github.io/aws-load-balancer-controller/latest/deploy/installation/#option-c-attach-iam-policies-to-nodes
