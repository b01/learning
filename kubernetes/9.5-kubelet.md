# Kubelet

* Is the agent used to connect nodes to the cluster.
* Responsible for starting all control plane components when they run as Pods.

## Bootstrap Requirements

1. `/var/lib/kubelet/config.yaml` - a Kublet configuration, here's a sample
   template similar to the one that kubeadm generates.
2. `/etc/kubernetes/kublet.conf` - a kubeconfig with embedded certificates to
   allow the kublet to communicate with the kube-api server on the control
   plane.
3. `/etc/kubernetest/pki/ca.crt` - the cluster certificate.
4. `/etc/systemd/system/kubelet.service.d/kubelet.conf` - a systemd unit
   config telling the kubelet agent where to find its configuration.

## Different Configurations Locations

Configuration locations get messy on Linux. It can be a real pain to find where
a program get its runtime settings from. The `kubelet` is no different. Here's a
compilation of places you can look.

Places to locate configurations for the kubelet:
* `/var/lib/kubelet/kubeadm-flags.env` - which contains the environment variable
  `KUBELET_KUBEADM_ARGS` that may be assigned a list of flags to pass to the
  kubelet when it starts.
* `/etc/default/kubelet`
* `/usr/lib/systemd/system/kubelet.service.d` - This configuration file
   installed by the kubeadm package.
* `/etc/systemd/system/kubelet.service.d/` - a directory you can make and put
  your own customizations into a file there.
* The file that can contain user-specified flag overrides with
  `KUBELET_EXTRA_ARGS` is sourced from `/etc/default/kubelet` (for DEBs), or
  `/etc/sysconfig/kubelet` (for RPMs). `KUBELET_EXTRA_ARGS` is last in the
  flag chain and has the highest priority in the event of conflicting settings.
* When you call kubeadm init, the kubelet configuration is marshalled to disk
  at `/var/lib/kubelet/config.yaml`, and also uploaded to a kubelet-config
  ConfigMap in the `kube-system` namespace of the cluster. A kubelet
  configuration file is also written to `/etc/kubernetes/kubelet.conf` with the
  baseline cluster-wide configuration for all kubelets in the cluster.

Example of what you are likely to find in
`/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf`:

```shell
[Service]
Environment="KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"
Environment="KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"
# This is a file that the user can use for overrides of the kubelet args as a last resort.
# KUBELET_EXTRA_ARGS should be sourced from this file.
EnvironmentFile=-/etc/default/kubelet
ExecStart=
ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS
```

## Useful Commands

Get the kubelet config from the kube-apiserver:
`kubectl get --raw "/api/v1/nodes/control-plane-01/proxy/configz" | jq`
or
`kubectl get nodes control-plane-01 -o json`

---

[kubelet.conf]: /kubernetes/samples/kublet.conf