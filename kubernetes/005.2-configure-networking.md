# Configure Networking

Before we begin, lets see what bridge networks we have so far:
`sudo bridge link show`. Just make a mental note, or paste the output for
reference later.

1. Add a default kubeconfig to access the cluster.
   ```shell
   mkdir -p $HOME/.kube
   sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
   sudo chown $(id -u):$(id -g) $HOME/.kube/config
   ```
2. Install a CNI addon, you have several choices:
    1. Install Flannel CNI:
        1. Download the manifest.
           ```shell
           wget https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
           ```
        2. Edit container spec to set the network interface to use:
           ```yaml
           containers:
            - args:
              - --ip-masq
              #...
              - --iface=enp0s8
           ```
           NOTE: Careful! Even if you use this [Vagrantfile], the network
           card may have a different name, be sure to check what name it has
           with `ip address` on the control plane VM.
        3. Optionally edit `vi kube-flannel.yml` to add IPv6:
           ```yaml
           data:
             net-conf.json: |
               {
                 "Network": "10.244.0.0/16",
                 "EnableNFTables": false,
                 "Backend": {
                  "Type": "vxlan"
                 },
                 "EnableIPv6": true,
                 "IPv6Network": "2001:db8:42:0::/56"
               }
           ```
    2. To get practice with Network Policies, install the Antrea addon.
        1. Install OvS on all nodes.
           ```shell
           sudo apt install -y openvswitch-switch openvswitch-common
           ```

           NOTE: See https://docs.openvswitch.org/en/latest/intro/install/debian/#installing-deb-packages

        2. Install Antrea via manifest:
           This uses [NodeIPAM within kube-controller-manager]
           ```shell
           ANTREA_VER=v2.5.1
           wget https://github.com/antrea-io/antrea/releases/download/${ANTREA_VER}/antrea.yml
           ```
        3. Modify the Antrea configuration to use the CIDRs previously chosen:
           ```text
           serviceCIDR: "10.96.0.0/16"
           serviceCIDRv6: "2001:db8:42:1::/112"
           transportInterface: "enp0s8"`
           ```
        4. Then apply it `kubectl apply -f antrea.yml`
           NOTE: The antrea.yml is over 6000 lines long. And has a Deployment
           the `antrea-controller` which take up 200m CPU and another DaemonSet
           the `antrea-agent` which will take up another 200m CPU on control-planes.
           That's 400m altogether, along with about 650m for the control-plane
           components. That's a total of 1050m CPU, so you'll need at least 2 CPUs
           per control-plane.

           NOTE: ClusterIP CIDR range for Services is only required when
           `AntreaProxy` is not enabled.
    3. Another alternative, install `kube-router` addon, which also provides
       Network Policy features, and we'll also replace `kube-proxy`.
       See [Deploying kube-router with kubeadm] for more details.
       1. When run as `DaemonSet`, the container image is prepackaged with
          `ipset`, but it MUST also be installed on each node user:
          ```shell
          sudo apt-get install -y ipset ipvsadm
          ```
       2. Make a `kube-router` manifest:
          ```shell
          wget https://raw.githubusercontent.com/cloudnativelabs/kube-router/master/daemonset/kubeadm-kuberouter.yaml
          k apply -f kubeadm-kuberouter.yaml
          ```
3. Test that DNS resolution for the cluster is working:
    1. Launch a Pod with DNS tools:
       `kubectl run -it --rm --restart=Never --image=infoblox/dnstools:latest dnstools`
    2. Query the DNS server:
       `host kubernetes`
    3. Now type `exit` and it should remove the  `dnstools` Pod since we used
       `--rm` flag.

Next: [Add Workers]

---

[CoreDNS Helm chart]: https://github.com/coredns/helm
[Add Workers]: /kubernetes/005.3-add-workers.md
[NodeIPAM within kube-controller-manager]: https://antrea.io/docs/main/docs/getting-started/#nodeipam-within-kube-controller-manager