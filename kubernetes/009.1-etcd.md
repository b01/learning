# etcd

The key-value database for the `kube-apiserver`. It stores the state of the
cluster. If you have a recent backup of the etcd database, then you can always
restore the cluster to that state.

This data is NOT encrypted. If you want encryption you can encrypt the backup.

This component should come first when bringing up a cluster, and here's why.
If you spin up the `kube-apiserver` first then it has to wait for the etcd
service before it can store any data.

`etcdctl` is the CLI tool used to interact with `etcd` server using API
versions 2 (the default) or 3.

Version 2 supports the following commands:

```shell
etcdctl backup
etcdctl cluster-health
etcdctl mk
etcdctl mkdir
etcdctl set
```

Whereas version 3

```shell
etcdctl snapshot save
etcdctl endpoint health
etcdctl get
etcdctl put
```

To set the right version of API set the environment variable ETCDCTL_API command

```shell
export ETCDCTL_API=3
```

Apart from that, you must also specify the path to certificate files so that
`etcdctl` can authenticate using TLS with the `etcd` server. The certificate
files are available, by default, at the following paths.

```text
--cacert /etc/kubernetes/pki/etcd/ca.crt
--cert /etc/kubernetes/pki/etcd/server.crt
--key /etc/kubernetes/pki/etcd/server.key
```

## Perform a Backup

1. Download `etcdctl` to the `control-plane-01` node.
   ```shell
   ETCD_VER=v3.6.8

   # choose either URL
   GOOGLE_URL=https://storage.googleapis.com/etcd
   GITHUB_URL=https://github.com/etcd-io/etcd/releases/download
   DOWNLOAD_URL=${GOOGLE_URL}

   rm -f /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz
   rm -rf /tmp/etcd-download-test && mkdir -p /tmp/etcd-download-test

   curl -L ${DOWNLOAD_URL}/${ETCD_VER}/etcd-${ETCD_VER}-linux-amd64.tar.gz -o /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz
   tar xzvf /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz -C /tmp/etcd-download-test --strip-components=1 --no-same-owner
   rm -f /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz
   ```
2. Test you can connect:
   ```shell
   sudo /tmp/etcd-download-test/etcdctl \
     --endpoints=https://[2000:192:168:56::11]:2379 \
     --cacert=/etc/kubernetes/pki/etcd/ca.crt \
     --cert=/etc/kubernetes/pki/etcd/server.crt \
     --key=/etc/kubernetes/pki/etcd/server.key \
     get / --prefix --keys-only --limit=10
   ```
3. Backup etcd database:
   ```shell
   # replace the IP with the control-plane IP
   sudo /tmp/etcd-download-test/etcdctl \
     --endpoints=https://[2000:192:168:56::11]:2379 \
     --cacert=/etc/kubernetes/pki/etcd/ca.crt \
     --cert=/etc/kubernetes/pki/etcd/server.crt \
     --key=/etc/kubernetes/pki/etcd/server.key \
     snapshot save ./backup-2026.db
   ```

---

[etcd Releases]: https://github.com/etcd-io/etcd/releases
