# Initialize the Control Plane

Time to start the kubelet service on the control-plane which, in turn, will
start the control-plane components using their manifest located in
`/etc/kubernetes/manifest`.

NOTE: This guide avoids some of the [TLS bootstrapping] process because it is a
cumbersome flow to perform manually.
However, the best part of the TLS bootstrapping process this guide will walk
you through. That's the part where the `kubelet` and the
`kube-controller-manager` are configured so that nodes can auto-renew their
TLS certificates.

1. Make a configuration for the `kubelet`:
   1. Copy the `samples/config.yaml` over to the `control-plane-01`.
   2. Move the `config.yaml` to `/var/lib/kubelet` directory:
      ```shell
      sudo mkdir -p /var/lib/kubelet
      sudo cp config.yaml /var/lib/kubelet
      ```
2. Customize the `systemd` unit for the `kubelet.service` by specifying the
   `kubelet` configuration file and the bootstrap kubeconfig file.
   ```shell
   sudo mkdir -p /etc/systemd/system/kubelet.service.d
   cat <<'TXT' | sudo tee /etc/systemd/system/kubelet.service.d/kubelet.conf
   [Service]
   Environment="KUBELET_KUBECONFIG_ARGS=--kubeconfig=/etc/kubernetes/kubelet.conf"
   Environment="KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"
   # This is a file that can be used to override kubelet CLI args set in the unit file installed with the package.
   # Or you can set KUBELET_EXTRA_ARGS, which should be sourced from this file.
   EnvironmentFile=-/etc/default/kubelet
   ExecStart=
   ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_EXTRA_ARGS
   TXT
   ```
3. Copy the `kubelet` key and certificate, and kubeconfig into place.
   ```shell
   sudo mkdir -p /var/lib/kubelet/pki
   sudo cp ~/certs/control-plane-01.key /var/lib/kubelet/pki/kubelet.key
   sudo cp ~/certs/control-plane-01.crt /var/lib/kubelet/pki/kubelet.crt
   sudo cp ~/certs/control-plane-01.conf /etc/kubernetes/kubelet.conf
   ```
4. Start the cluster components.
   ```shell
   sudo systemctl daemon-reload
   sudo systemctl start kubelet.service
   ```
5. Then check the status of the `kubelet` to make sure it booted successfully.
   ```shell
   sudo systemctl status kubelet.service
   ```
6. Mark the node as a control-plane by adding the following Label and Taint.
   The Taint will prevent Pods from being scheduled on the control-plane unless
   configured to do so; while the label distinguishes it from worker nodes.
   ```shell
   sudo kubectl label nodes control-plane-01 control-plane="" \
     --kubeconfig=/etc/kubernetes/super-admin.conf
   sudo kubectl taint nodes control-plane-01 control-plane:NoSchedule \
     --kubeconfig=/etc/kubernetes/super-admin.conf
   ```
   NOTE: We have not set a default kubeconfig for accessing the cluster at this
   point, which is why we have to specify one. Very useful when you need to try
   out a different config for any reason.

NOTE: If your having issues you can review the `kubelet` logs with
`sudo journalctl -u kubelet.service`.

Next: [Configure Networking]

---

[TLS bootstrapping]: https://kubernetes.io/docs/reference/access-authn-authz/kubelet-tls-bootstrapping
[Configure Networking]: /kubernetes/4.5-configure-networking.md
