# Cluster Installation Overview

## Manual Cluster Installation

Get hands-on with each component of a cluster. By having you configure each
component you'll gain greater understanding of the overall cluster architecture.

Manually deploying a Kubernetes cluster is very beneficial as it can:
1. Help you learn where all the components are, and their corresponding
   configurations are located.
2. You'll likely mess-it-up, which is good because now you'll have a cluster
   that you can practice troubleshooting; which can be a great learning boost.
3. Grant you more knowledge to compliment any courses you have taken.
4. Speed up your ability to resolve issues.
5. Give you detailed insights to aid in your journey as a CKA.

### Checklist

1. Begin by preparing virtual machines for cluster installation by following
   the [Setup A Virtual Environment] guide.
2. [Install containerd: Manual Installation] as the CRI of choice on all
   machines.
3. [Install Kubernetes packages] using the system package manager on all machines.
4. Choose which IP CIDR ranges you want to use for IPv4 and/or IPv6 for the
   clusters' Pod and Service networks; or use the ranges provided.
5. [Generate Control Plane Certificates Manually] to set up cluster PKI.
6. [Generate Control Plane kubeconfigs Manually] for components and cluster
   admins.
7. [Generate Static Pod Manifests] for components:
   1. `etcd`
   2. `kube-apiserver`
   3. `kube-controller-manager`
   4. `kube-scheduler`
8. [Initialize the Control Plane] by starting the `kubelet` service on the
   `control-plane-01` node.
9. [Configure Networking] by deploying a `kube-proxy` [DaemonSet], CoreDNS, and
   Flannel CNI network addon on `control-plane-01` node.
10. [Add Workers] nodes to the cluster.

To take this path click the [Manual Cluster Install].

## Cluster Installation with kubeadm

This is how it is done in the real world. kubeadm automates all the tedious
setup of PKI, components, control-plane, nodes, and more.

This will do a lot of the heavily lifting for initial deployment and upgrading.

### Checklist

1. Prepare the machines for cluster installation by following the
   [Setup A Virtual Environment] guide, then return back here.
2. [Install containerd: Ubuntu Package Manager] as the CRI of choice on the
   control plane and nodes.
3. See instruction for [Installing kubeadm, kubelet and kubectl].
    * If you run into any issues see [Troubleshooting kubeadm].
4. Choose which IP CIDR ranges you want to use for IPv4 and/or IPv6 for the
   Pod and service networks.
5. Run `kubeadm init` with desired configuration to initialize component on the
   control-plane-01 machine.
6. [Installing Addons] (CNI compliant) to facilitate Pod Networking.
   NOTE: For brevity this guide shows how to install the `Flannel` add-on.
7. Run "kubeadm join..." command on each worker worker-01 and worker-02.

To take this path click the [kubeadm Cluster Install].

## Dual Stack

For either manual or tool assisted setups you can make a Dual stack cluster.
In addition, you also have to decide if it will be IPv6 or IPv4 Primary. Making
this decision simply involves listing either IPv6 or IPv4 family first and
consistently across configurations.

In order to properly configure a cluster for dual-stack, here's what you
should know:
1. Select IPv6 and IPv4 CIDR blocks for both the Pod and Service Networks, for
   example, these are the CIDRs used in this guide:
   ```text
   IPv4 POD network:     10.244.0.0/16
   IPv4 Service Network: 10.96.0.0/16
   IPv6 POD network:     2001:db8:42:0::/56
   IPv6 Service Network: 2001:db8:42:1::/112
   ```
2. Decide if you want to make IPv6 Primary cluster, meaning it defaults to use
   IPv6 addresses. This is done by setting the IPv6 address before the
   IPv4 address in any comma separated strings or YAML arrays.
3. Make sure to set both IPv6 and IPv4 CIDR blocks in any configuration where
   needed, for example in te `kubeadm` init configuration, again setting the
   IPv6 address first when you want to make it Primary. For example:
   ```yaml
   # excerpt from sample init config, dual-stack with IPv6 Primary
   networking:
     podSubnet: 2001:db8:42:0::/56,10.244.0.0/16
     serviceSubnet: 2001:db8:42:1::/112,10.96.0.0/16
   ```
4. You MUST also inject both IPv6 and IPv4 addresses into the `kubelet`
   configuration either in the environment variable
   `KUBELET_EXTRA_ARGS`, `--node-ip` flag, or directly in a configuration file
   you use. Here's how you'd set them in the environment variable, again make
   note of the order if you want an IPv6 Primary cluster:
   ```shell
   KUBELET_EXTRA_ARGS="--node-ip=2000:192:168:56::11,192.168.56.11"
   ```
   You can use the [generate-kubelet-extra-args.sh] script during your install
   to set the `KUBELET_EXTRA_ARGS` environment variable so that your kubelet
   gets the correct IPs. Note this script is intended for an IPv6 Primary
   cluster.
5. Your services can also make use of dual-stack. Review this
   [dual-stack-preferred-svc.yaml] configuration for how.
6. You can set `advertiseAddress` to the nodes adapter's IPv6 address. As an
   IPv4 will leave it in IPv4 mode only.
   ```yaml
   ---
   apiVersion: kubeadm.k8s.io/v1beta4
   kind: InitConfiguration
   localAPIEndpoint:
     advertiseAddress: <set-IPv6-address>
   ```
7. Use the Kubernetes documented process to [Validate IPv4/IPv6 dual-stack]
   clusters.

## Important Resources

These aid in comprehension of manual or tool assisted Kubernetes cluster
installations.

* [Cluster Architecture]
* [Download binaries / Images]
* [Cluster Networking]

---

[Install containerd: Ubuntu Package Manager]: /kubernetes/003.0-install-containerd.md#ubuntu-package-manager
[Setup A Virtual Environment]: /kubernetes/002.0-setup-a-virtual-environment.md
[Installing kubeadm, kubelet and kubectl]: https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#installing-kubeadm-kubelet-and-kubectl
[Troubleshooting kubeadm]: https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/
[Creating a cluster with kubeadm]: https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/
[Cluster Architecture]: https://kubernetes.io/docs/concepts/architecture/#kube-apiserver
[Download binaries / Images]: https://kubernetes.io/releases/download/
[Manual Cluster Install]: /kubernetes/004.0-manual-cluster-install.md
[kubeadm Cluster Install]: /kubernetes/005.0-kubeadm-cluster-install.md
[Installing Addons]: https://kubernetes.io/docs/concepts/cluster-administration/addons/#networking-and-network-policy
[Cluster Networking]: https://kubernetes.io/docs/concepts/cluster-administration/networking/
[Install containerd: Manual Installation]: /kubernetes/003.0-install-containerd.md#manual-installation
[DaemonSet]: /kubernetes/samples/kube-proxy.yaml.tmpl
[Generate Control Plane Certificates Manually]: /kubernetes/004.1-generate-control-plane-certificates-manually.md
[Generate Control Plane kubeconfigs Manually]: /kubernetes/004.2-generate-control-plane-kubeconfigs-manually.md
[Generate Static Pod Manifests]: /kubernetes/004.3-generate-static-pod-manifests.md
[Initialize the Control Plane]: /kubernetes/004.4-initialize-the-control-plane.md
[Configure Networking]: /kubernetes/004.5-configure-networking.md
[Add Workers]: /kubernetes/004.6-add-workers.md
[Install Kubernetes packages]: /kubernetes/003.1-install-kubernetes-packages.md
[Validate IPv4/IPv6 dual-stack]: https://kubernetes.io/docs/tasks/network/validate-dual-stack/
[generate-kubelet-extra-args.sh](/kubernetes/samples/generate-kubelet-extra-args.sh)
[dual-stack-preferred-svc.yaml](/kubernetes/samples/dual-stack-preferred-svc.yaml)
