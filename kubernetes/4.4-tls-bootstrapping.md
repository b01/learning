# TLS bootstrapping

This process generates a kubeconfig that avoids the [TLS bootstrapping] process.
We have opted to make a permanent kubeconfig over make a bootstrap kubeconfig
for the sake of brevity.

1. Generate a `kubelet` boostrap token file:
   ```shell
   export BOOTSTRAP_TOKEN="$(head -c 16 /dev/urandom | od -An -t x | tr -d ' ')"
   cat <<TXT | sudo tee /etc/kubernetes/bootstrap-token
   ${BOOTSTRAP_TOKEN},kubelet-bootstrap,10001,"system:bootstrappers"
   TXT
   ```
2. Generate a kubeconfig for the `kubelet` to use.
   ```shell
   i="bootstrap-kubelet"
   user_name="default-auth"
   sudo kubectl config set-cluster ${CLUSTER_NAME} \
        --certificate-authority=${cert_dir}/ca.crt \
        --embed-certs=true \
        --server=${CLUSTER_ENDPOINT} \
        --kubeconfig=/etc/kubernetes/${i}.conf

   sudo kubectl config set-credentials ${user_name} \
        --token=${BOOTSTRAP_TOKEN} \
        --kubeconfig=/etc/kubernetes/${i}.conf

   sudo kubectl config set-context default \
        --cluster=${CLUSTER_NAME} \
        --user=${user_name} \
        --kubeconfig=/etc/kubernetes/${i}.conf

   sudo kubectl config use-context default \
        --kubeconfig=/etc/kubernetes/${i}.conf
   ```
4. Copy the `samples/config.yaml` over to the `control-plane-01`.
   2. Move the `config.yaml` to `/var/lib/kubelet` directory:
      ```shell
      sudo mkdir -p /var/lib/kubelet
      sudo cp config.yaml /var/lib/kubelet
      ```
3. Customize the `systemd` unit for the `kubelet.service` by specifying the
   kubelet configuration file and the bootstrap kubeconfig file.
   ```shell
   sudo mkdir -p /etc/systemd/system/kubelet.service.d
   cat <<'TXT' | sudo tee /etc/systemd/system/kubelet.service.d/kubelet.conf
   [Service]
   Environment="KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"
   Environment="KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"
   # This is a file that can be used to override kubelet service args set in the unit file provided by the package installation.
   # Or you can set KUBELET_EXTRA_ARGS, which should be sourced from this file.
   EnvironmentFile=-/etc/default/kubelet
   ExecStart=
   ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_EXTRA_ARGS
   TXT
   ```
3. Start the cluster
   ```shell
   sudo systemctl daemon-reload
   sudo systemctl start kubelet.service
   ```
   NOTE: That the kubelet will not have access to the kube-apiserver at this
   point, which is OK. We fix that in the next few steps.

Next: [Configure Networking]

---

[TLS bootstrapping]: https://kubernetes.io/docs/reference/access-authn-authz/kubelet-tls-bootstrapping
[Configure Networking]: /kubernetes/4.5-configure-networking
