# Persistent Volume Claim

A Persistent Volume Claim (PVC) is an object that is bound to a Persistent
Volume (PV), which in turn, binds the PV to a Pod.

The name of a PersistentVolumeClaim object must be a valid DNS subdomain name.

The field `accessModes` in a PVC spec:
* is used to match a PV to bind to.
* in some cases, it also constrains where the PV can be mounted.
* does not enforce write protection once the storage has been mounted.
* when set to **ReadWriteOncePod**, constrains it to a single Pod.
* ensure a volume is mounted using only that mode.

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: web-server-pvc
spec:
  accessModes:
    - ReadWriteOnce
  volumeMode: Filesystem
  resources:
    requests:
      storage: 8Gi
  storageClassName: slow
  selector:
    matchLabels:
      release: "stable"
    matchExpressions:
      - {key: environment, operator: In, values: [dev]}
```

It should be mentioned again, that when it comes to Local storage, that if you
set the PV `volumeBindingMode` to **WaitForFirstConsumer**, then DO NOT use the
Pod spec `affinity` and child field `nodeName`. This will prevent the PVC from
binding to available volumes and leave it in "Pending" status.

The **Storage Object in Use Protection** feature ensures that a PVC in active
use by a Pod and a PV are not removed from the system.

If a user deletes a PVC in active use by a Pod, it is not removed immediately.
Its removal is postponed until the PVC is no longer actively used by any Pods.

You can see that a PVC is protected when the PVC's status is _Terminating_
and the `Finalizers` list includes `kubernetes.io/pvc-protection`.

You can try this out. Make a PV, bind a PVC to it, then deploy a Pod using the
PVC. Then try to delete the PVC, and then review the PVC's descriptions. You
can try this with the example below:
```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-storage-delete-test
provisioner: kubernetes.io/no-provisioner
volumeBindingMode: WaitForFirstConsumer
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: local-pv-delete-test
spec:
  capacity:
    storage: 2Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteOnce
  storageClassName: local-storage-delete-test
  local: # You MUST run the command `mkdir -p /tmp/local-storage` on worker-01.
    path: /tmp/local-storage
  nodeAffinity: # Field is required for Local storage.
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
              - worker-01
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: local-pvc-delete-test
spec:
  storageClassName: local-storage-delete-test
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: Pod
metadata:
  name: pod-delete-test
  labels:
    app: local-storage-delete-test
spec:
  containers:
    - image: nginx:latest
      name: nginx
      ports:
        - containerPort: 80
      volumeMounts:
        - mountPath: "/usr/share/nginx/html/public"
          name: public
  volumes:
    - name: public
      persistentVolumeClaim:
        claimName: local-pvc-delete-test
```

```shell
kubectl delete pvc local-pvc-delete-test
kubectl describe pvc local-pvc-delete-test
```
Output:
```shell
Name:          local-pvc-delete-test
Namespace:     default
StorageClass:  local-storage-delete-test
Status:        Terminating (lasts 7m31s)
Volume:        local-pv-delete-test
Labels:        <none>
Annotations:   pv.kubernetes.io/bind-completed: yes
               pv.kubernetes.io/bound-by-controller: yes
Finalizers:    [kubernetes.io/pvc-protection]
Capacity:      2Gi
Access Modes:  RWO
VolumeMode:    Filesystem
Used By:       pod-delete-test
```