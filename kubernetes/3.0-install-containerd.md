# Install containerd

These are the quick-notes for manual or OS package manager installations of
`containerd.` For the full guides visit [Getting started with containerd].

Before we begin, lets see what bridge networks we have so far:
`sudo bridge link show`. Just make a mental note, or paste the output for
reference later.
You can also list the contents of the `/sys/class/net/<bridge-name>/brif`
directory to see the interfaces in a bridge:
```shell
ls /sys/class/net/br0/brif
```

## Manual Installation

1. Download a version of the `containerd` archive:
   ```shell
   ARCH=$(dpkg --print-architecture)
   CTND_VER=2.1.3
   wget https://github.com/containerd/containerd/releases/download/v${CTND_VER}/containerd-${CTND_VER}-linux-${ARCH}.tar.gz
   ```
2. Install `containerd`:
   ```shell
   sudo tar Cxzvf /usr/local ~/containerd-${CTND_VER}-linux-amd64.tar.gz
   ```
3. Download the `containerd` service configuration:
   ```shell
   wget https://raw.githubusercontent.com/containerd/containerd/refs/tags/v${CTND_VER}/containerd.service
   sudo install -m 755 ~/containerd.service /etc/systemd/system
   sudo systemctl daemon-reload
   sudo systemctl enable --now containerd
   ```
4. Add a configuration for `containerd` to use the systemd driver, set the following option
   in /etc/containerd/config.toml:
   ```toml
   version = 3
   [plugins.'io.containerd.cri.v1.runtime'.containerd.runtimes.runc.options]
     SystemdCgroup = true
   ```
   ```toml
       [plugins.'io.containerd.cri.v1.images'.pinned_images]
         sandbox = 'registry.k8s.io/pause:3.10'
   ```
   NOTE: See [CRI Plugin Config Guide] more specifically [Basic configuration]
5. Download and install `runc`:
   ```shell
   wget https://github.com/opencontainers/runc/releases/download/v1.3.0/runc.${ARCH}
   sudo install -m 755 ~/runc.${ARCH} /usr/local/sbin/runc
   ```
6. Download and install `CNI plugins`:
   ```shell
   CNI_VER=v1.7.1
   wget https://github.com/containernetworking/plugins/releases/download/${CNI_VER}/cni-plugins-linux-${ARCH}-${CNI_VER}.tgz
   sudo mkdir -p /opt/cni/bin
   sudo tar Cxzvf /opt/cni/bin cni-plugins-linux-${ARCH}-${CNI_VER}.tgz
   ```
7. Add the default `containerd` configuration:
   ```shell
   sudo mkdir -p /etc/containerd
   containerd config default | sudo tee /etc/containerd/config.toml
   ```
8. Start the `containerd` service with `sudo systemctl start containerd`
9. Test:
   ```shell
   sudo ctr images pull docker.io/library/hello-world:latest
   sudo ctr run docker.io/library/hello-world:latest hi
   ```
10. [Install cri-tools] very useful for debugging pods when booting a cluster.
    ```shell
    VERSION="v1.33.0" # check latest version in /releases page
    wget https://github.com/kubernetes-sigs/cri-tools/releases/download/$VERSION/crictl-$VERSION-linux-amd64.tar.gz
    sudo tar zxvf crictl-$VERSION-linux-amd64.tar.gz -C /usr/local/bin
    rm -f crictl-$VERSION-linux-amd64.tar.gz
    # configure to use containerd as the container runtime.
    cat <<TXT | sudo tee /etc/crictl.yaml
    runtime-endpoint: unix:///run/containerd/containerd.sock
    image-endpoint: unix:///run/containerd/containerd.sock
    TXT
    ```

## Ubuntu Package Manager

1. Follow instructions here: https://docs.docker.com/engine/install/ubuntu/
   1. Set up Docker's apt repository by running these commands on each node:
      ```shell
      # Add Docker's official GPG key:
      sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
      sudo chmod a+r /etc/apt/keyrings/docker.asc

      # Add the repository to Apt sources:
      echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
      $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
      sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
      sudo apt-get update
      ```
2. Install the latest version:
   ```shell
   sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
   ```
3. Add the default `containerd` configuration:
   ```shell
   containerd config default | sudo tee /etc/containerd/config.toml
   ```
4. Edit the `containerd` configuration `sudo vi /etc/containerd/config.toml`:
   1. To use the **systemd** driver, set the following option
      in /etc/containerd/config.toml:
      ```toml
      version = 2
      ...
                [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
                  SystemdCgroup = true
      ```
   2. To edit `/etc/containerd/config.toml` to use the latest sandbox image for
      k8s:
      ```toml
        [plugins."io.containerd.grpc.v1.cri"]
          ...
          sandbox_image = "registry.k8s.io/pause:3.10"
      ```
5. Restart the service `sudo systemctl restart containerd`.
   NOTE: See [CRI Plugin Config Guide] more specifically [Basic configuration]
6. Set your cgroup drivers.
   1. To set **systemd** as the cgroup driver, edit the KubeletConfiguration option
      of cgroupDriver and set it to **systemd** `cgroupDriver: systemd`

---

[Getting started with containerd]: https://github.com/containerd/containerd/blob/main/docs/getting-started.md
[Ubuntu apt-get]: https://docs.docker.com/engine/install/ubuntu/
[CRI Plugin Config Guide]: https://github.com/containerd/containerd/blob/main/docs/cri/config.md
[Basic configuration]: https://github.com/containerd/containerd/blob/main/docs/cri/config.md#basic-configuration
[Install cri-tools]: https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md
