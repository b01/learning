# Add User

## Manually

For details see [Issue a Certificate for a Kubernetes API Client Using A CertificateSigningRequest]
For more details visit [How to issue a certificate for a user]

TLDR is as follows:

1. Make a new private key for the user: `openssl genrsa -out jump-box.key 3072`.
2. Make an X.509 certificate signing request (CSR:
   `openssl req -new -key jump-box.key -out jump-box.csr -subj "/CN=jump-box"`
3. Copy it to the control-plane-01 machine:
   `scp jump-box.csr vagrant@controlplane:~/`.
4. On the control-plane-01 machine, run this command to make a Kubernetes
   CertificateSigningRequest:
   ```shell
   # The base64-encoded contents of jump-box.csr
   CERT="$(cat jump-box.csr | base64 -w 0)"

   cat <<TXT | kubectl apply -f -
   # This is an encoded CSR.
   apiVersion: certificates.k8s.io/v1
   kind: CertificateSigningRequest
   metadata:
     name: jump-box
   spec: # ${CERT} should be the base64-encoded contents of jump-box.csr
    request: ${CERT}
    signerName: kubernetes.io/kube-apiserver-client
    expirationSeconds: 86400  # one day
    usages:
    - client auth
   TXT
   ```
5. Approve the request:
   ```shell
   kubectl get certificatesigningrequests.certificates.k8s.io
   kubectl certificate approve <certificate-signing-request-name>
   ```
6. Get the certificate and save it as `jump-box.crt` on the jump-box:
   ```shell
   # Get the certificate, base64 decode it, then save it as a file on the jump-box.
   kubectl get csr jump-box -o jsonpath='{.status.certificate}' | base64 -d | ssh vagrant@192.168.56.10 tee jump-box.crt
   ```
   NOTE: You may have to look up the IP of the `jump-box` by running `ip address`.
7. Get the cluster CA certificate and save it as `ca.crt` on the jump-box:
   ```shell
   # Get the certificate, base64 decode it, then save it as a file on the jump-box.
   sudo cat /etc/kubernetes/pki/ca.crt | ssh vagrant@192.168.56.10 tee ca.crt
   ```
   NOTE: You may have to look up the IP of the `jump-box` by running `ip address`.
8. Back on the `jump-box`, make a new kubeconfig for the jump-box to use by
   default:
   ```shell
   # Define a cluster to connect to:
   kubectl config set-cluster practice-cluster \
     --embed-certs --certificate-authority=ca.crt \
     --server=https://control-plane-01:6443
   # Set the credentials to use to authenticate with the cluster:
   kubectl config set-credentials jump-box \
     --client-key=jump-box.key \
     --client-certificate=jump-box.crt \
     --embed-certs=true
   # Define a context that ties a user to a cluster:
   kubectl config set-context practice --cluster=practice-cluster --user=jump-box
   ```
9. Test the config works: `kubectl auth whoami`.
10. On the `control-plane-01` make a new cluster role binding for the
    `jumb-box` to grant it `cluster-admin` privileges:
    ```shell
    kubectl create clusterrolebinding jump-box --clusterrole=cluster-admin --user=jump-box
    ```
11. Back on the `jump-box` test out the permissions by running `k get pods -A`.

Practice this a few time to get comfortable with it if you plan to take the
CKA exam.

## Add User with kubeadm

Generate a cluster admin kubeconfig using kubeadm:

```shell
mkdir -p ~/.kube
# NOTE: The config kubeadm-conf.yaml must exist on the control-plane-01 machine.
ssh vagrant@control-plane-01 sudo kubeadm kubeconfig user --client-name=jump-box --org=kubeadm:cluster-admins --config=kubeadm-conf.yaml | tee -a ~/.kube/config
```

---

[How to issue a certificate for a user]: https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/#normal-user
[Signing certificate signing requests (CSR) generated by kubeadm]: https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/#signing-csr
[Issue a Certificate for a Kubernetes API Client Using A CertificateSigningRequest]: https://kubernetes.io/docs/tasks/tls/certificate-issue-client-csr/
