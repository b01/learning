# Define and enforce Network Policies

Used to control traffic flow at the IP address or port level for TCP, UDP, and
SCTP protocols. For other protocols, such as ARP or ICMP, the behaviour is
undefined.

To use network policies, you must be using a CNI networking solution which
supports NetworkPolicy. See [Install a Network Policy Provider] for options.

When a new NetworkPolicy object is created, it may take some time for a network
plugin to handle the new object.

NetworkPolicies apply to a connection with a Pod on one or both ends.

Categories of Pod communication are:

1. Other Pods that are allowed
2. Namespaces that are allowed
3. IP blocks that are allowed.

NOTE: Some exceptions. A Pod cannot block access to itself. Nor traffic to and
from the node where a Pod is running.

Pod isolation means "some restrictions apply". There is isolation for `egress`,
and isolation for `ingress`. The alternative, "non-isolated for $direction",
means that no restrictions apply. By default, a pod is non-isolated for both
directions.

A pod is isolated for `egress` if there is any NetworkPolicy that both selects
the Pod and has "Egress" in its `policyTypes`. The same goes for `ingress`.

Network policies do not conflict; they are additive. Meaning the connections
allowed in a direction is a union of what the applicable policies allow.

The `egress` policy on a source Pod and the `ingress` policy on a destination
Pod need to allow the connection.

A network policy spec:
* As with all other config, a `NetworkPolicy` needs `apiVersion`, `kind`, and
  `metadata` fields.
* `spec` - has all the information needed to define a particular network policy
  in the given namespace.
  * `podSelector` - selects the grouping of pods to which the policy applies.
  * `policyTypes` -  list which may include either Ingress, Egress, or both.
  * `ingress` - a list of allowed ingress rules. Rule allows traffic which
    matches both the `from` and `ports` sections.
  * `egress` - a list of allowed egress rules. Rule allows traffic which
    matches both the `to` and `ports` sections.

  NOTE: Target a range of ports instead of a single port by using the `endPort`
  field.

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: test-network-policy
  namespace: default
spec:
  podSelector:
    matchLabels:
      role: db
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - ipBlock:
        cidr: 172.17.0.0/16
        except:
        - 172.17.1.0/24
    - namespaceSelector:
        matchLabels:
          project: myproject
    - podSelector:
        matchLabels:
          role: frontend
    ports:
    - protocol: TCP
      port: 6379
  egress:
  - to:
    - ipBlock:
        cidr: 10.0.0.0/24
    ports:
    - protocol: TCP
      port: 5978
```

See [NetworkPolicySpec] or [networkpolicy-v1].


You can create a "default" ingress isolation policy for a namespace by creating
a NetworkPolicy that selects all pods but does not allow any ingress traffic to
those pods.

```yaml
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
spec:
  podSelector: {}
  policyTypes:
  - Ingress
```

Alternatively to allow all Ingress:
```yaml
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-all-ingress
spec:
  podSelector: {}
  ingress:
  - {}
  policyTypes:
  - Ingress
```

Be careful to use correct YAML syntax. For example:
Policy A:
```yaml
  # ...
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          user: alice
      podSelector:
        matchLabels:
          role: client
```
Policy B:
```yaml
  #...
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          user: alice
    - podSelector:
        matchLabels:
          role: client
```

`Policy A` contains a single `from` element allowing connections from Pods
with the label `role=client` in namespaces with the label `user=alice`.

`Policy B` contains two elements in the `from` array, and allows connections
from Pods in the local Namespace with the label `role=client`, or from any Pod in
any namespace with the label `user=alice`.

---

[Install a Network Policy Provider]: https://kubernetes.io/docs/tasks/administer-cluster/network-policy-provider/
[Installing Addons]: https://kubernetes.io/docs/concepts/cluster-administration/addons/
[NetworkPolicySpec]: https://kubernetes.io/docs/reference/kubernetes-api/policy-resources/network-policy-v1/#NetworkPolicySpec
[networkpolicy-v1]: https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.33/#networkpolicy-v1-networking-k8s-io
