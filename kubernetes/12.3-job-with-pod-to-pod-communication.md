# Job with Pod-to-Pod Communication

This exercise makes use of [Indexed completion mode] and [headless services].

Jobs in Indexed completion mode automatically set the pods' hostname to be in
the format of `${jobName}-${completionIndex}`. A headless service will trigger
the DNS system to create records of the hostnames of the pods running your Job.
All that is required is to place the service in the same namespace and give it
a selector to match the job. Use the default namespace for convenience of less
typing.

This configuration will make a headless service and a job to test the desired
functionality.
```shell
cat <<'TXT' | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: headless-svc
spec:
  clusterIP: None # clusterIP must be None to create a headless service
  selector:
    job-name: job-p2p-comm # must match Job name
---
apiVersion: batch/v1
kind: Job
metadata:
  name: job-p2p-comm
spec:
  completions: 3
  parallelism: 3
  completionMode: Indexed
  template:
    spec:
      subdomain: headless-svc # has to match Service name
      restartPolicy: Never
      containers:
      - name: example-workload
        image: bash:latest
        command:
        - bash
        - -c
        - |
          for i in 0 1 2
          do
            gotStatus="-1"
            wantStatus="0"
            while [ $gotStatus -ne $wantStatus ]
            do
              ping -c 1 job-p2p-comm-${i}.headless-svc > /dev/null 2>&1
              gotStatus=$?
              if [ $gotStatus -ne $wantStatus ]; then
                echo "Failed to ping pod job-p2p-comm-${i}.headless-svc, retrying in 1 second..."
                sleep 1
              fi
            done
            echo "Successfully pinged pod: job-p2p-comm-${i}.headless-svc"
          done
TXT
```

Review the logs of the jobs.
`kubectl logs <job-pod-name>`

**Output**

```shell
Failed to ping pod example-job-0.headless-svc, retrying in 1 second...
Successfully pinged pod: example-job-0.headless-svc
Successfully pinged pod: example-job-1.headless-svc
Successfully pinged pod: example-job-2.headless-svc
```

---

[Indexed completion mode]: https://kubernetes.io/blog/2021/04/19/introducing-indexed-jobs/
[headless services]: https://kubernetes.io/docs/concepts/services-networking/service/#headless-services
