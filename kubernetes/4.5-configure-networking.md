# Configure Networking

1. Add a default kubeconfig to access the cluster.
   ```shell
   mkdir -p ~/.kube
   sudo cp /etc/kubernetes/admin.conf ~/.kube/config
   sudo chown vagrant:vagrant ~/.kube/config
   chmod 0700 ~/.kube/config
   ```
2. Copy the `kube-proxy.tmpl.yaml` file to `control-plane-01`.
3. Fill in the values for the `kube-proxy` config and then apply the manifest.
   ```shell
   export ADVERTISE_ADDRESS=192.168.56.11
   export POD_CIDRS=10.244.0.0/16,2001:db8:42:0::/56
   export SERVICE_CIDRS=10.96.0.0/16,2001:db8:42:1::/112
   export KUBE_VER=v1.33.3
   envsubst < kube-proxy.tmpl.yaml | tee kube-proxy.yaml
   kubectl apply -f kube-proxy.yaml
   ```
4. Install Helm
   ```shell
   wget https://get.helm.sh/helm-v3.18.4-linux-amd64.tar.gz
   sudo tar Czxvf /usr/local/bin/ helm-v3.18.4-linux-amd64.tar.gz --strip-components=1
   ```
5. Install CoreDNS using the [CoreDNS Helm chart].
   ```shell
   helm repo add coredns https://coredns.github.io/helm
   helm repo update
   helm --namespace=kube-system install coredns coredns/coredns
   ```
6. Install Flannel CNI:
   1. Download the manifest.
      ```shell
      wget https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
      ```
   2. Edit container spec to set the network interface to use:
      ```yaml
      containers:
       - args:
         - --ip-masq
         #...
         - --iface=enp0s8
      ```
      NOTE: Be careful, even if you use this [Vagrantfile], the network card may
      have a different name, be sure to check what name it has with `ip address`
      on the control plane VM.
   3. Optionally edit `vi kube-flannel.yml` to add IPv6:
      ```yaml
      data:
        net-conf.json: |
          {
            "Network": "10.244.0.0/16",
            "EnableNFTables": false,
            "Backend": {
             "Type": "vxlan"
            },
            "EnableIPv6": true,
            "IPv6Network": "2001:db8:42:0::/56"
          }
      ```
7. Test that DNS resolution for the cluster is working:
   1. Launch a Pod with DNS tools:
      `kubectl run -it --rm --restart=Never --image=infoblox/dnstools:latest dnstools`
   2. Query the DNS server:
      `host kubernetes`
   3. Now remove the test pod with `kubectl delete pod dnstools`.

Next: [Add Workers]

---

[CoreDNS Helm chart]: https://github.com/coredns/helm
[Add Workers]: /kubernetes/4.6-add-workers.md
