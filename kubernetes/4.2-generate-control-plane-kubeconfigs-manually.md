# Generate Control Plane kubeconfigs Manually

NOTE: If you need to view what is in a certificate, use
`openssl x509  -noout -text -in ./server.crt`.

1. We're going to work from the same `~/certs` directory where we generated
   keys and certs, and also use the same environment variables, plus a shell
   function to help speed things up:
   ```shell
   cert_dir=/etc/kubernetes/pki
   CLUSTER_NAME=kubernetes
   CLUSTER_ENDPOINT=https://192.168.56.11:6443

   cd ~/certs

   gen_kubeconfig() {
      i="${1}"
      user_name="${2}"
      sudo kubectl config set-cluster ${CLUSTER_NAME} \
           --certificate-authority=${cert_dir}/ca.crt \
           --embed-certs=true \
           --server=${CLUSTER_ENDPOINT} \
           --kubeconfig=/etc/kubernetes/${i}.conf
   
      sudo kubectl config set-credentials ${user_name} \
           --client-certificate=${i}.crt \
           --client-key=${i}.key \
           --embed-certs=true \
           --kubeconfig=/etc/kubernetes/${i}.conf
   
      sudo kubectl config set-context default \
           --cluster=${CLUSTER_NAME} \
           --user=${user_name} \
           --kubeconfig=/etc/kubernetes/${i}.conf
   
      sudo kubectl config use-context default \
           --kubeconfig=/etc/kubernetes/${i}.conf
   }
   ```
2. Generate a kubeconfig file for the `controller-manager` at
   `/etc/kubernetes/controller-manager.conf`, with a CN of
   `system:kube-controller-manager`.
   ```shell
   gen_kubeconfig "controller-manager" "default-controller-manager"
   ```
3. Generate a kubeconfig file for scheduler at `/etc/kubernetes/scheduler.conf`; inside
   this file is embedded a client certificate with scheduler identity. This
   client certificate should have the CN `system:kube-scheduler`.
   ```shell
   gen_kubeconfig "scheduler" "default-scheduler"
   ```
4. Generate a kubeconfig file for `kube-proxy` at
   `/etc/kubernetes/kube-proxy.conf`; inside this file is embedded a client
   certificate with CN `system:kube-proxy` identity and the
   `system:node-proxier` organization.
   ```shell
   gen_kubeconfig "kube-proxy" "system:kube-proxy"
   ```
5. Generate the `admin` and `super-admin` kubeconfigs.
   ```shell
   gen_kubeconfig "admin" "default-admin"
   gen_kubeconfig "super-admin" "default-super-admin"
   ```
6. generate a kubeconfig for each worker node:
   ```shell
   cd ~/certs
   cert_dir=/etc/kubernetes/pki
   CLUSTER_NAME=kubernetes
   CLUSTER_ENDPOINT=https://192.168.56.11:6443

   nodes=("control-plane-01" "control-plane-02" "worker-01" "worker-02")
   for i in ${nodes[*]}
   do
       # Make a kubeconfig for the node adding the cluster.
       sudo kubectl config set-cluster ${CLUSTER_NAME} \
        --certificate-authority=${cert_dir}/ca.crt \
        --embed-certs=true \
        --server=${CLUSTER_ENDPOINT} \
        --kubeconfig=${i}.conf
       # Add credentials to the kubeconfig.
       sudo kubectl config set-credentials ${i} \
        --client-certificate=${i}.crt \
        --client-key=${i}.key \
        --embed-certs=true \
        --kubeconfig=${i}.conf
      # Add a context to the cluster.
      sudo kubectl config set-context default \
        --cluster=${CLUSTER_NAME} \
        --user=${i} \
        --kubeconfig=${i}.conf
      # Set the context to use by default in the kubeconfig.
      sudo kubectl config use-context default \
        --kubeconfig=${i}.conf
   done
   ```

Next: [Generate Static Pod Manifests]

---

[Generate Static Pod Manifests]: /kubernetes/4.3-generate-static-pod-manifests.md
