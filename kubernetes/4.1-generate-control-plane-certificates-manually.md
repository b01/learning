# Generate Control Plane Certificates Manually

You will need to generate TLS keys and certificates for the
following control plane components:
* etcd,
* kube-apiserver,
* kube-controller-manager,
* kube-scheduler,
* kubelet,
* and kube-proxy.

`kube-apiserver`, `etcd`, and `front-proxy` will all have their own Certificate
Authority (CA).

The kubelet is specific for each node, so certificates and kubeconfigs will
be generated for each control plane and worker node that needs to connect to
the cluster. Which we will do manually, thankfully there are only 3 machines.

NOTE: This [PKI Infrastructure] will be built using openssl. The provided
CA configuration is based on the Kubernetes documented
[PKI certificates and requirements]. To help you can review [x509v3_config]
documentation.

## Manually Build etcd CA, Keys, & Certificates

Make a Certificate Authority for `ectd` server that can be used to generate
additional TLS certificates for the health-check, server, and peer endpoints.

```shell
etcd_certs=("healthcheck-client" "peer" "server")
etcd_cert_dir=/etc/kubernetes/pki/etcd
CERT_DAYS=365
CERT_BITS=2048
ETCD_CERT_CONF="openssl-etcd.conf"

sudo mkdir -p ${etcd_cert_dir}

# Generate the etcd CA key.
sudo openssl genrsa -out "${etcd_cert_dir}/ca.key" ${CERT_BITS}

# Generate the etcd CA certificate.
sudo openssl req -x509 -new -sha256 -noenc \
    -key "${etcd_cert_dir}/ca.key" -days ${CERT_DAYS} \
    -config ${ETCD_CERT_CONF} -section etcd \
    -out "${etcd_cert_dir}/ca.crt"

# Generate the etcd server, clients, and heath-check keys and certs.
for i in ${etcd_certs[*]}; do
  sudo openssl genrsa -out "${etcd_cert_dir}/${i}.key" ${CERT_BITS}

  sudo openssl req -new -key "${etcd_cert_dir}/${i}.key" -sha256 \
    -config "${ETCD_CERT_CONF}" -section ${i} \
    -out "${i}.csr"

  sudo openssl x509 -req -days ${CERT_DAYS} -in "${i}.csr" \
    -copy_extensions copyall \
    -sha256 -CA "${etcd_cert_dir}/ca.crt" \
    -CAkey "${etcd_cert_dir}/ca.key" \
    -CAcreateserial \
    -out "${etcd_cert_dir}/${i}.crt"
done

# remove the openssl serial no. count increment file.
sudo rm -rf /etc/kubernetes/pki/etcd/ca.srl
```

## Manually Build Control Plane Keys & Certificates

Make a couple of CAs for the control plane that can be used to generate
additional TLS certificates for the other components. We can save a little bit
of time by using the `openssl-control-plane.conf` with all the details needed
to generate certificates. We should also set some environment variables to make
it a bit reusable.

```shell
cert_dir=/etc/kubernetes/pki
CLUSTER_CN=kubernetes
CERT_DAYS=365
CERT_BITS=2048
CERT_CONF="openssl-control-plane.conf"
CLUSTER_NAME=kubernetes
CLUSTER_ENDPOINT=https://192.168.56.11:6443

sudo mkdir -p ${cert_dir}
```

Generates certificate and private key pairs for different purposes:

1. A self-signed CA for the Kubernetes cluster saved into
   `/etc/kubernetes/pki/ca.crt` file and `/etc/kubernetes/pki/ca.key` private
   key file:
   ```shell
   sudo openssl genrsa -out "${cert_dir}/ca.key" ${CERT_BITS}
   sudo openssl req -x509 -new -nodes \
       -key "${cert_dir}/ca.key" \
       -subj "/CN=${CLUSTER_CN}" \
       -days ${CERT_DAYS} -out "${cert_dir}/ca.crt"
   ```
2. Generate certificates for items listed, signed by the Kubernetes CA `ca.crt`,
   and saved into `/etc/kubernetest/pki`.
   ```shell
   certificates=("apiserver" "apiserver-kubelet-client")
   for i in ${certificates[*]}
   do
       sudo openssl genrsa -out "${cert_dir}/${i}.key" ${CERT_BITS}
       # Make a Certificate Signing Request
       sudo openssl req -new -key "${cert_dir}/${i}.key" -sha256 \
            -config "${CERT_CONF}" -section ${i} \
            -out "${i}.csr"
       # Sign the CSR with the kubernetes-ca.
       sudo openssl x509 -req -days ${CERT_DAYS} -in "${i}.csr" \
            -copy_extensions copyall \
            -sha256 -CA "${cert_dir}/ca.crt" \
            -CAkey "${cert_dir}/ca.key" \
            -CAcreateserial \
            -out "${cert_dir}/${i}.crt"
   done
   ```
3. A private key for signing ServiceAccount Tokens saved into `sa.key` file
   along with its public key `sa.pub`.
   ```shell
   sudo openssl genrsa -out "${cert_dir}/sa.key" ${CERT_BITS}
   sudo openssl rsa -pubout -in "${cert_dir}/sa.key" -out "${cert_dir}/sa.pub"
   ```
4. A certificate authority for the front proxy saved into `front-proxy-ca.crt`
   file with its key `front-proxy-ca.key`:
   ```shell
   i="front-proxy-ca"
   sudo openssl genrsa -out "${cert_dir}/${i}.key" ${CERT_BITS}
   sudo openssl req -x509 -new -nodes \
       -key "${cert_dir}/${i}.key" \
       -subj "/CN=${i}" \
       -days ${CERT_DAYS} -out "${cert_dir}/${i}.crt"
   ```
5. A client certificate for the front proxy client, generated using
   `front-proxy-ca.crt`, and saved into `front-proxy-client.crt` file with
   its private key `front-proxy-client.key`.
   ```shell
   i="front-proxy-client"
   sudo openssl genrsa -out "${cert_dir}/${i}.key" ${CERT_BITS}

   sudo openssl req -new -key "${cert_dir}/${i}.key" -sha256 \
   -config "${CERT_CONF}" -section ${i} \
   -out "${i}.csr"

   sudo openssl x509 -req -days ${CERT_DAYS} -in "${i}.csr" \
   -copy_extensions copyall \
   -CAkey "${cert_dir}/front-proxy-ca.key" \
   -sha256 -CA "${cert_dir}/front-proxy-ca.crt" \
   -CAcreateserial \
   -out "${cert_dir}/${i}.crt"
   ```

## Generate Authentication Certificates To Embed in kubeconfigs

1. Generate a client certificate file for the controller-manager that will be
   embedded in the kubeconfig at `/etc/kubernetes/controller-manager.conf`,
   with a CN of `system:kube-controller-manager`.
   ```shell
   i="controller-manager"
   user_name="default-controller-manager"
   sudo openssl genrsa -out "${i}.key" ${CERT_BITS}

   sudo openssl req -new -key "${i}.key" -sha256 \
   -config "${CERT_CONF}" -section ${i} \
   -out "${i}.csr"

   sudo openssl x509 -req -days ${CERT_DAYS} -in "${i}.csr" \
   -copy_extensions copyall \
   -CAkey "${cert_dir}/ca.key" \
   -sha256 -CA "${cert_dir}/ca.crt" \
   -CAcreateserial \
   -out "${i}.crt"
   ```
2. Generate a key and certificate for the `kube-scheduler` that will be embedded
   in the kubeconfig at `/etc/kubernetes/scheduler.conf`. This client
   certificate should have the CN `system:kube-scheduler`.
   ```shell
   i="scheduler"
   sudo openssl genrsa -out "${i}.key" ${CERT_BITS}

   sudo openssl req -new -key "${i}.key" -sha256 \
   -config "${CERT_CONF}" -section ${i} \
   -out "${i}.csr"

   sudo openssl x509 -req -days ${CERT_DAYS} -in "${i}.csr" \
   -copy_extensions copyall \
   -CAkey "${cert_dir}/ca.key" \
   -sha256 -CA "${cert_dir}/ca.crt" \
   -CAcreateserial \
   -out "${i}.crt"
   ```
3. Generate a client certificate for the `kube-proxy` to connect to the API
   server, that will be embedded in the kubeconfig at
   `/etc/kubernetes/kube-proxy.conf`.
   ```shell
   i="kube-proxy"
   sudo openssl genrsa -out "${i}.key" ${CERT_BITS}

   sudo openssl req -new -key "${i}.key" -sha256 \
   -config "${CERT_CONF}" -section ${i} \
   -out "${i}.csr"

   sudo openssl x509 -req -days ${CERT_DAYS} -in "${i}.csr" \
   -copy_extensions copyall \
   -CAkey "${cert_dir}/ca.key" \
   -sha256 -CA "${cert_dir}/ca.crt" \
   -CAcreateserial \
   -out "${i}.crt"
   ```
4. Generate a key and certificate for the admin and client kubeconfig.
   ```shell
   i="admin"
   user_name="default-admin"
   sudo openssl genrsa -out "${i}.key" ${CERT_BITS}

   sudo openssl req -new -key "${i}.key" -sha256 \
   -config "${CERT_CONF}" -section ${i} \
   -out "${i}.csr"

   sudo openssl x509 -req -days ${CERT_DAYS} -in "${i}.csr" \
   -copy_extensions copyall \
   -CAkey "${cert_dir}/ca.key" \
   -sha256 -CA "${cert_dir}/ca.crt" \
   -CAcreateserial \
   -out "${i}.crt"
   ```
5. Generate a key and certificate for the super-admin and client kubeconfig.
   ```shell
   i="super-admin"
   user_name="default-super-admin"
   sudo openssl genrsa -out "${i}.key" ${CERT_BITS}

   sudo openssl req -new -key "${i}.key" -sha256 \
   -config "${CERT_CONF}" -section ${i} \
   -out "${i}.csr"

   sudo openssl x509 -req -days ${CERT_DAYS} -in "${i}.csr" \
   -copy_extensions copyall \
   -CAkey "${cert_dir}/ca.key" \
   -sha256 -CA "${cert_dir}/ca.crt" \
   -CAcreateserial \
   -out "${i}.crt"
   ```

## Generate kube-apiserver-etcd-client

This will allow the `kube-apiserver` to authenticate with the etcd server.

```shell
i="apiserver-etcd-client"

sudo openssl genrsa -out "${cert_dir}/${i}.key" ${CERT_BITS}

sudo openssl req -new -key "${cert_dir}/${i}.key" -sha256 \
 -config "${CERT_CONF}" -section ${i} \
 -out "${i}.csr"

# sign the CSR with the etcd-ca key.
sudo openssl x509 -req -days ${CERT_DAYS} -in "${i}.csr" \
 -copy_extensions copyall \
 -sha256 -CA "${etcd_cert_dir}/ca.crt" \
 -CAkey "${etcd_cert_dir}/ca.key" \
 -CAcreateserial \
 -out "${cert_dir}/${i}.crt"
```

## Generate kubelet Certificates

For each node, we're going to need a certificate for the `kubelet` to
authenticate with the `kube-apiserver`. Each certificate will be unique, as
it will use the hostname of the node as a subject alternative name. In addition,
these certificates will also double as the serving certificate when clients need
to connect to the kubelet, such as when the kube-apiserver want to fetch
metrics.

1. Copy the OpenSSL config file `openssl-kubelets.conf` to the
   `control-plane-01` nodes' `~certs` directory.
2. Generate a key and certificate (signed by the Kubernetes CA) for each node's
   `kubelet` to use.
   ```shell
   cd ~/certs
   CERT_BITS=2048
   CERT_DAYS=365
   WORKER_CONF="openssl-kubelets.conf"
   cert_dir=/etc/kubernetes/pki
   CLUSTER_NAME=kubernetes
   CLUSTER_ENDPOINT=https://192.168.56.11:6443

   nodes=("control-plane-01" "worker-01" "worker-02")
   for i in ${nodes[*]}
   do
       # generate a key
       sudo openssl genrsa -out "${i}.key" ${CERT_BITS}
       # make a CSR
       sudo openssl req -new -key "${i}.key" -sha256 \
         -config "${WORKER_CONF}" -section ${i} \
         -out "${i}.csr"
       # Use the cluster CA to sign the CSR and make a certificate.
       sudo openssl x509 -req -days ${CERT_DAYS} -in "${i}.csr" \
          -copy_extensions copyall \
          -CAkey "${cert_dir}/ca.key" \
          -sha256 -CA "${cert_dir}/ca.crt" \
          -CAcreateserial \
          -out "${i}.crt"
   done
   ```

Next: [Generate Control Plane Configs Manually]

---

[PKI Infrastructure]: https://en.wikipedia.org/wiki/Public_key_infrastructure
[Generate Control Plane Configs Manually]: /kubernetes/4.2-generate-control-plane-kubeconfigs-manually.md
[PKI certificates and requirements]: https://kubernetes.io/docs/setup/best-practices/certificates/
[x509v3_config]: https://docs.openssl.org/master/man5/x509v3_config/
