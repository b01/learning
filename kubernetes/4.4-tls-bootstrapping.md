# TLS bootstrapping

This process allows a `kubelet` to using an authorization method to authenticate
with the `kube-apiserver` then generate a long-term TLS certificate for inself.
It will also renew that certificate when its expiration time is near.

See [TLS bootstrapping] for more details.

1. Generate a `kubelet` boostrap token file:
   ```shell
   export BOOTSTRAP_TOKEN="$(head -c 16 /dev/urandom | od -An -t x | tr -d ' ')"
   cat <<TXT | sudo tee /etc/kubernetes/bootstrap-token
   ${BOOTSTRAP_TOKEN},kubelet-bootstrap,10001,"system:bootstrappers"
   TXT
   ```
2. Ensure the `kube-apiserver` options `--enable-bootstrap-token-auth=true` and
   `--token-auth-file=/etc/kubernetes/bootstrap-token`.  If not, then set it
   then restart the `kube-apiserver`.
3. Enable bootstrapping nodes to make a CSR by adding this ClusterRole on
   the `control-plane-01`.
   ```yaml
   # enable bootstrapping nodes to make CSR
   apiVersion: rbac.authorization.k8s.io/v1
   kind: ClusterRoleBinding
   metadata:
     name: create-csrs-for-bootstrapping
   subjects:
   - kind: Group
     name: system:bootstrappers
     apiGroup: rbac.authorization.k8s.io
   roleRef:
     kind: ClusterRole
     name: system:node-bootstrapper
     apiGroup: rbac.authorization.k8s.io
   ```
4. Configure the controller-manager so that it auto-approves all CSRs for
   the group "system:bootstrappers".
   ```yaml
   # Approve all CSRs for the group "system:bootstrappers"
   apiVersion: rbac.authorization.k8s.io/v1
   kind: ClusterRoleBinding
   metadata:
     name: auto-approve-csrs-for-group
   subjects:
   - kind: Group
     name: system:bootstrappers
     apiGroup: rbac.authorization.k8s.io
   roleRef:
     kind: ClusterRole
     name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
     apiGroup: rbac.authorization.k8s.io
   ```
5. To enable the kubelet to renew its own client certificate, make a
   ClusterRoleBinding:
   ```yaml
   # Approve renewal CSRs for the group "system:nodes"
   apiVersion: rbac.authorization.k8s.io/v1
   kind: ClusterRoleBinding
   metadata:
     name: auto-approve-renewals-for-nodes
   subjects:
   - kind: Group
     name: system:nodes
     apiGroup: rbac.authorization.k8s.io
   roleRef:
     kind: ClusterRole
     name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
     apiGroup: rbac.authorization.k8s.io
   ```
6. Generate a bootstrap kubeconfig for all `kublet`s to use:
   ```shell
   kubectl config set-cluster bootstrap \
     --server='https://192.168.56.11:6443' \
     --certificate-authority=/etc/kubernetes/pki/ca.crt \
     --kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf

   kubectl config set-credentials kubelet-bootstrap \
     --token=${BOOTSTRAP_TOKEN} \
     --kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf

   kubectl config set-context bootstrap \
     --user=kubelet-bootstrap \
     --cluster=bootstrap \
     --kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf

   kubectl config use-context bootstrap \
     --kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf
   ```
7. Copy the `samples/config.yaml` over to the `control-plane-01`.
   ```shell
   sudo mkdir -p /var/lib/kubelet
   sudo cp /vagrant/config.yaml /var/lib/kubelet
   ```
   NOTE: This ONLY works if you copy the local repository locally and ran
   `vagrant up` in the `samples` directory.
8. Customize the `systemd` unit for the `kubelet.service` by specifying the
   kubelet configuration file and the bootstrap kubeconfig file.
   ```shell
   sudo mkdir -p /etc/systemd/system/kubelet.service.d
   cat <<'TXT' | sudo tee /etc/systemd/system/kubelet.service.d/kubelet.conf
   [Service]
   Environment="KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"
   Environment="KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"
   # This is a file that can be used to override kubelet service args set in the unit file provided by the package installation.
   # Or you can set KUBELET_EXTRA_ARGS, which should be sourced from this file.
   EnvironmentFile=-/etc/default/kubelet
   ExecStart=
   ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_EXTRA_ARGS
   TXT
   ```
9. Start the cluster
   ```shell
   sudo systemctl daemon-reload
   sudo systemctl start kubelet.service
   ```
   NOTE: That the kubelet will not have access to the kube-apiserver at this
   point, which is OK. We fix that in the next few steps.

Next: [Configure Networking]

---

[TLS bootstrapping]: https://kubernetes.io/docs/reference/access-authn-authz/kubelet-tls-bootstrapping
[Configure Networking]: /kubernetes/4.5-configure-networking
